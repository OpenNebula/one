---
- name: Check hosts connectivity
  hosts: all
  gather_facts: false
  tasks:
    - name: Wait for hosts to be up
      ansible.builtin.wait_for_connection:
        timeout: 300
    - name: Wait for hosts to be reachable through SSH
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        state: started
        timeout: 60
  tags: always

# ------------------------------------------------------------------------------
# One-deploy playbooks
# ------------------------------------------------------------------------------
- ansible.builtin.import_playbook: opennebula.deploy.main

# ------------------------------------------------------------------------------
# Steps for shared NFS clusters using ds.config.mounts
# Ensures mount targets exist so symlinks created by datastore roles are not dangling
# ------------------------------------------------------------------------------
- name: Ensure NFS datastore target directories exist (shared NFS clusters)
  hosts: frontend
  become: true
  gather_facts: false
  tasks:
    - name: Create SYSTEM/IMAGE datastore target directories on the NFS share
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: 9869
        group: 9869
        mode: "0755"
      loop: "{{ ds.config.mounts | default([]) }}"
      when:
        - ds is defined
        - ds.mode | default('') == 'shared'
        - ds.config is defined
        - ds.config.mounts is defined
        - item.type in ['system', 'image']

# ------------------------------------------------------------------------------
# Other playbooks (optional)
# ------------------------------------------------------------------------------
# - name: 'Example role'
#   hosts: all
#   tasks:
#     - name: 'Example task'
#       ansible.builtin.debug:
#         msg: 'Hello, world!'
#   tags: always
