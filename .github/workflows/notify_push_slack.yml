name: Slack Push Notifier

on:
  push:
    branches: [master]
  pull_request:
    types: [closed]
    branches: [master]
  workflow_dispatch:

jobs:
  notify_slack_push:
    name: Notify Slack on pushes
    runs-on: ubuntu-latest
    steps:
      - name: String manipulation
        run: echo "COMMIT_ONELINER=${{ github.event.head_commit.message }}${{ github.event.pull_request.title }}"|grep -v '^$'|head -1 >> $GITHUB_ENV

      - name: It is a merged pull request
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.merged == true  && github.repository == 'OpenNebula/one-ee' }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "New push to master"
            blocks: 
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "> --> *New Commit:* <${{ github.event.head_commit.url }}|${{ env.COMMIT_ONELINER }}>"

      - name: It is a direct push
        if: ${{ github.event_name == 'push' && github.repository == 'OpenNebula/one-ee' }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "New push to master"
            blocks: 
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "> --> *New Commit:* <${{ github.event.head_commit.url }}|${{ env.COMMIT_ONELINER }}>"
