/* -------------------------------------------------------------------------- */
/* Copyright 2002-2011, OpenNebula Project Leads (OpenNebula.org)             */
/*                                                                            */
/* Licensed under the Apache License, Version 2.0 (the "License"); you may    */
/* not use this file except in compliance with the License. You may obtain    */
/* a copy of the License at                                                   */
/*                                                                            */
/* http://www.apache.org/licenses/LICENSE-2.0                                 */
/*                                                                            */
/* Unless required by applicable law or agreed to in writing, software        */
/* distributed under the License is distributed on an "AS IS" BASIS,          */
/* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.   */
/* See the License for the specific language governing permissions and        */
/* limitations under the License.                                             */
/* -------------------------------------------------------------------------- */

/*Templates tab plugin*/

var templates_tab_content = 
'<form id="template_form" action="" action="javascript:alert(\'js error!\');">\
  <div class="action_blocks">\
  </div>\
<table id="datatable_templates" class="display">\
  <thead>\
    <tr>\
      <th class="check"><input type="checkbox" class="check_all" value="">All</input></th>\
      <th>ID</th>\
      <th>User</th>\
      <th>Name</th>\
      <th>Registration time</th>\
      <th>Public</th>\
    </tr>\
  </thead>\
  <tbody id="tbodytemplates">\
  </tbody>\
</table>\
</form>';

var create_template_tmpl = '<div id="template_create_tabs">\
	<ul>\
		<li><a href="#easy">Wizard KVM</a></li>\
		<li><a href="#easy">Wizard XEN</a></li>\
		<li><a href="#easy">VMWare</a></li>\
		<li><a href="#manual">Advanced mode</a></li>\
	</ul>\
	<div id="easy">\
		<form>\
			<div id="template_type" style="margin-bottom:1em;">\
				<!--\
				<div class="clear"></div>\
				<label for="template_type">Select VM type:</label>\
				<input type="radio" id="kvm" name="template_type" value="kvm">KVM</input>\
				<input type="radio" id="xen" name="template_type" value="xen">XEN</input>\
				<div class="clear"></div>\
				-->\
				<p style="font-size:0.8em;text-align:right;"><i>Fields marked with <span style="display:inline-block;" class="ui-icon ui-icon-alert" /> are mandatory</i><br />\
				<a href="#" id="fold_unfold_vm_params"><u>Fold / Unfold all sections</u></a></p>\
			</div>\
\
			  <!-- capacity section name, memory, cpu vcpu -->\
			  <div class="vm_section" id="capacity">\
			    <div class="show_hide" id="add_capacity_cb">\
				  <h3>Capacity options</h3>\
			    </div>\
			  <fieldset><legend>Capacity</legend>\
				<div class="vm_param kvm_opt xen_opt vmware_opt">\
				  <label for="NAME">Name:</label>\
				  <input type="text" id="NAME" name="name"/>\
				  <div class="tip">	Name that the VM will get for description purposes. If NAME is not supplied a name generated by one will be in the form of one-&lt;VID&gt;.</div>\
				</div>\
			    <div class="vm_param kvm xen vmware_opt">\
				  <label for="MEMORY">Memory:</label>\
				  <input type="text" id="MEMORY" name="memory" size="4" />\
				  <div class="tip">Amount of RAM required for the VM, in Megabytes.</div>\
			    </div>\
     		    <div class="vm_param kvm_opt xen_opt">\
				<label for="CPU">CPU:</label>\
				  <input type="text" id="CPU" name="cpu" size="2"/>\
				  <div class="tip">Percentage of CPU divided by 100 required for the Virtual Machine. Half a processor is written 0.5.</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt">\
				  <label for="VCPU">VCPU:</label>\
				  <input type="text" id="VCPU" name="vcpu" size="3" />\
				  <div class="tip">Number of virtual cpus. This value is optional, the default hypervisor behavior is used, usually one virtual CPU.</div>\
			    </div>\
			  </fieldset>\
			  </div>\
			  <!-- OS and Boot options\
				arch, kernel, initrd, root, kernel_cmd, bootloader, boot\
			  -->\
			<div class="vm_section" id="os_boot_opts">\
			    <div class="show_hide" id="add_os_boot_opts_cb">\
			    <h3>Boot/OS options <a id="add_os_boot_opts" class="icon_left" href="#"><span class="ui-icon ui-icon-plus" /></a></h3>\
			    </div>\
			  <fieldset><legend>OS and Boot options</legend>\
				<div class="vm_param kvm vmware">\
				  <label for="ARCH">Architecture:</label>\
				  <select id="ARCH" name="arch">\
					<option value="i686">i686</option>\
					<option value="x86_64">x86_64</option>\
				  </select>\
				  <div class="tip">CPU architecture to virtualization</div>\
				</div>\
				<!--xen necesita kernel o bootloader.\
				Opciones de kernel son obligatorias si se activa kernel-->\
				<div class="" id="kernel_bootloader">\
				  <label>Boot method:</label>\
				  <select id="boot_method" name="boot_method">\
				    <option id="no_boot" name="no_boot" value=""></option>\
					<option value="kernel">Kernel</option>\
					<option value="bootloader">Bootloader</option>\
				  </select>\
				  <div class="tip">Select boot method</div>\
				</div>\
			    <div class="vm_param kvm_opt xen kernel">\
				  <label for="KERNEL">Kernel:</label>\
				  <input type="text" id="KERNEL" name="kernel" />\
				  <div class="tip">Path to the OS kernel to boot the image</div>\
				</div>\
     		    <div class="vm_param kvm xen kernel">\
				  <label for="INITRD">Initrd:</label>\
				  <input type="text" id="INITRD" name="initrd"/>\
				  <div class="tip">Path to the initrd image</div>\
			    </div>\
			    <div class="vm_param kvm xen kernel">\
				  <label for="ROOT">Root:</label>\
				  <input type="text" id="ROOT" name="root"/>\
				  <div class="tip">Device to be mounted as root</div>\
			    </div>\
				<div class="vm_param kvm xen kernel">\
				  <label for="KERNEL_CMD">Kernel commands:</label>\
				  <input type="text" id="KERNEL_CMD" name="kernel_cmd" />\
				  <div class="tip">Arguments for the booting kernel</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen bootloader">\
				  <label for="BOOTLOADER">Bootloader:</label>\
				  <input type="text" id="BOOTLOADER" name="bootloader" />\
				  <div class="tip">Path to the bootloader executable</div>\
			    </div>\
			    <div class="vm_param kvm">\
				  <label for="BOOT">Boot:</label>\
				  <select id="BOOT" name="boot">\
					<option value="hd">hd</option>\
					<option value="fd">fd</option>\
					<option value="cdrom">cdrom</option>\
					<option value="network">network</option>\
				  </select>\
				  <div class="tip">Boot device type</div>\
			    </div>\
			    </fieldset>\
			  </div>\
\
\
			  <!--disks section using image or declaring\
			  image, image ID, bus, target, driver\
			  type, source, size, format, clone, save,\
			  readonly  SEVERAL DISKS-->\
			  <div class="vm_section" id="disks">\
				  <div class="show_hide" id="add_disks_cb">\
				  <h3>Add disks/images <a id="add_disks" class="icon_left" href="#"><span class="ui-icon ui-icon-plus" /></a></h3>\
			     </div>\
			   <fieldset><legend>Disks</legend>\
			     <div class="" id="image_vs_disk">\
				  <label>Add disk/image</label>\
				  <input type="radio" id="add_disk" name="image_vs_disk" value="disk">Disk</input>\
				  <!--<label for="add_disk">Add a disk</label>-->\
				  <input type="radio" id="add_image" name="image_vs_disk" value="image">Image</input>\
				  <!--<label for="add_image">Add an image</label>-->\
			     </div>\
			    <div class="clear"></div>\
			    <div class="vm_param kvm xen vmware add_image">\
				  <label for="IMAGE">Image:</label>\
				  <select type="text" id="IMAGE_ID" name="image_id">\
				  </select>\
				  <div class="tip">Name of the image to use</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt">\
				  <label for="BUS">Bus:</label>\
				  <select id="BUS" name="bus">\
				  </select>\
				  <div class="tip">Type of disk device to emulate: ide, scsi</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware">\
				  <label for="TARGET">Target:</label>\
				  <input type="text" id="TARGET" name="target" />\
				  <div class="tip">	Device to map image disk. If set, it will overwrite the default device mapping</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt">\
				  <label for="DRIVER">Driver:</label>\
				  <input type="text" id="DRIVER" name="driver" />\
				  <div class="tip">Specific image mapping driver. KVM: raw, qcow2. Xen:tap:aio:, file:. VMware unsupported</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt add_disk">\
				  <label for="TYPE">Type:</label>\
				  <select id="TYPE" name="type">\
				  </select>\
				  <div class="tip">Disk type</div>\
			    </div>\
			    <div class="vm_param kvm xen vmware add_disk">\
				  <label for="SOURCE">Source:</label>\
				  <input type="text" id="SOURCE" name="source" />\
				  <div class="tip">Disk file location path or URL</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt add_disk ">\
			    <!--Mandatory for swap, fs and block images-->\
				  <label for="SIZE">Size:</label>\
				  <input type="text" id="SIZE" name="size" />\
				  <div class="tip">Disk file location path or URL. Mandatory for swap, fs and block images</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt add_disk ">\
			    <!--mandatory for fs images-->\
				  <label for="FORMAT">Format:</label>\
				  <input type="text" id="FORMAT" name="format" />\
				  <div class="tip">Filesystem type for the fs images</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt add_disk">\
				  <label for="CLONE">Clone:</label>\
				  <select id="CLONE" name="clone">\
					<option value="yes">Yes</option>\
					<option value="no">No</option>\
				  </select>\
				  <div class="tip">Clone this image</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt add_disk">\
				  <label for="SAVE">Save:</label>\
				   <select id="SAVE" name="save">\
				    <option value="no">No</option>\
					<option value="yes">Yes</option>\
				  </select>\
				  <div class="tip">Save this image after shutting down the VM</div>\
			    </div>\
				<div class="vm_param kvm_opt xen_opt vmware_opt add_disk">\
				  <label for="READONLY">Read only:</label>\
				  <select id="READONLY" name="readonly">\
				    <option value="no">No</option>\
					<option value="yes">Yes</option>\
				  </select>\
				  <div class="tip">Mount image as read-only</div>\
			    </div>\
			    <div class="">\
					<button class="add_remove_button add_button" id="add_disk_button" value="add_disk">Add</button>\
					<button class="add_remove_button" id="remove_disk_button" value="remove_disk">Remove selected</button>\
					<div class="clear"></div>\
					<label style="" for="disks_box">Current disks:</label>\
					<select id="disks_box" name="disks_box" style="width:150px;height:100px;" multiple>\
					</select>\
					<div class="clear"></div>\
					</div>\
			  </fieldset>\
			  </div>\
\
			  <!-- network section  network, network id,, ip, mac,\
			  bridge, target,  script, model -->\
			  <div class="vm_section" id="networks">\
			    <div class="show_hide" id="add_networks_cb">\
			      <h3>Setup Networks <a id="add_networks" class="icon_left" href="#"><span class="ui-icon ui-icon-plus" /></a></h3>\
			    </div>\
			  <fieldset><legend>Network</legend>\
			    <div class="" id="network_vs_niccfg">\
				  <label>Add network</label>\
				  <input type="radio" id="add_network" name="network_vs_niccfg" value="network">Predefined</input>\
				  <!--<label style="width:200px;" for="add_network">Pre-defined network</label>-->\
				  <input type="radio" id="add_niccfg" name="network_vs_niccfg" value="niccfg">Manual</input>\
				  <!--<label for="add_niccfg">Manual network</label>-->\
				  <!--<div class="tip"></div>-->\
			    </div>\
			    <div class="clear"></div>\
				<div class="vm_param kvm xen vmware network">\
				  <label for="NETWORK">Network:</label>\
				  <select type="text" id="NETWORK_ID" name="network_id">\
				  </select>\
				  <div class="tip">Name of the network to attach this device</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt niccfg">\
				  <label for="IP">IP:</label>\
				  <input type="text" id="IP" name="ip" />\
				  <div class="tip">Request an specific IP from the Network</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt niccfg">\
				  <label for="MAC">MAC:</label>\
				  <input type="text" id="MAC" name="mac" />\
				  <div class="tip">HW address associated with the network interface</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt niccfg">\
				  <label for="BRIDGE">Bridge</label>\
				  <input type="text" id="BRIDGE" name="bridge" />\
				  <div class="tip">	Name of the bridge the network device is going to be attached to</div>\
			    </div>\
			    <div class="vm_param kvm_opt vmware_opt niccfg">\
				  <label for="TARGET">Target:</label>\
				  <input type="text" id="TARGET" name="nic_target" />\
				  <div class="tip">Name for the tun device created for the VM</div>\
			    </div>\
			    <div class="vm_param kvm_opt vmware_opt niccfg">\
				  <label for="SCRIPT">Script:</label>\
				  <input type="text" id="SCRIPT" name="script" />\
				  <div class="tip">Name of a shell script to be executed after creating the tun device for the VM</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt niccfg">\
				  <label for="MODEL">Model:</label>\
				  <input type="text" id="MODEL" name="model" />\
				  <div class="tip">Hardware that will emulate this network interface. With Xen this is the type attribute of the vif.</div>\
			    </div>\
			    <div class="">\
			        <button class="add_remove_button add_button" id="add_nic_button" value="add_nic">Add</button>\
				    <button class="add_remove_button" id="remove_nic_button" value="remove_nic">Remove selected</button>\
				    <div class="clear"></div>\
					<label for="nics_box">Current NICs:</label>\
					<select id="nics_box" name="nics_box" style="width:150px;height:100px;" multiple>\
					</select>\
					 </div>\
			  </fieldset>\
			  </div>\
\
\
			  <!--Input several type, bus-->\
			  <div class="vm_section" id="inputs">\
			  	<div class="show_hide" id="add_inputs_cb">\
			  	  <h3>Add inputs <a id="add_inputs" class="icon_left" href="#"><span class="ui-icon ui-icon-plus" /></a></h3>\
			    </div>\
			  <fieldset><legend>Inputs</legend>\
			  	<div class="vm_param kvm_opt">\
				  <label for="TYPE">Type:</label>\
				  <select id="TYPE" name="input_type">\
					<option value="mouse">Mouse</option>\
					<option value="tablet">Tablet</option>\
				  </select>\
				  <div class="tip"></div>\
			    </div>\
			    <div class="vm_param kvm_opt">\
				   <label for="BUS">Bus:</label>\
				  <select id="BUS" name="input_bus">\
					<option value="usb">USB</option>\
					<option value="ps2">PS2</option>\
					<option value="xen">XEN</option>\
				  </select>\
				  <div class="tip"></div>\
			    </div>\
			    <div class="">\
					<button class="add_remove_button add_button" id="add_input_button" value="add_input" class="kvm_opt">Add</button>\
					<button class="add_remove_button" id="remove_input_button" value="remove_input" class="kvm_opt">Remove selected</button>\
					<div class="clear"></div>\
					<label for="inputs_box">Current inputs:</label>\
					<select id="inputs_box" name="inputs_box" style="width:150px;height:100px;" multiple>\
					</select>\
					</div>\
			  </fieldset>\
			  </div>\
\
\
			  <!--graphics type, listen, port, passwd, keymap -->\
			  <div class="vm_section" id="graphics">\
			  	<div class="show_hide" id="add_graphics_cb">\
			  	  <h3>Add Graphics <a id="add_graphics" class="icon_left" href="#"><span class="ui-icon ui-icon-plus" /></a></h3>\
			    </div>\
			  <fieldset><legend>Graphics</legend>\
			    <div class="vm_param kvm_opt xen_opt">\
				  <label for="TYPE">Graphics type:</label>\
				  <select id="TYPE" name="">\
                    <option value="">Please select</option>\
					<option id="vnc" value="vnc">VNC</option>\
					<option value="sdl">SDL</option>\
				  </select>\
				  <div class="tip"></div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt">\
				  <label for="LISTEN">Listen IP:</label>\
				  <input type="text" id="LISTEN" name="graphics_ip" />\
				  <div class="tip">IP to listen on</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt">\
				  <label for="PORT">Port:</label>\
				  <input type="text" id="PORT" name="port" />\
				  <div class="tip">Port for the VNC server</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt">\
				  <label for="PASSWD">Password:</label>\
				  <input type="text" id="PASSWD" name="graphics_pw" />\
				  <div class="tip">Password for the VNC server</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt">\
				  <label for="KEYMAP">Keymap</label>\
				  <input type="text" id="KEYMAP" name="keymap" />\
				  <div class="tip">Keyboard configuration locale to use in the VNC display</div>\
			    </div>\
			  </fieldset>\
			  </div>\
\
\
			  <!--context textarea? -->\
			  <div class="vm_section" id="context">\
			  	<div class="show_hide" id="add_context_cb">\
			  	  <h3>Add context variables <a id="add_context" class="icon_left" href="#"><span class="ui-icon ui-icon-plus" /></a></h3>\
			    </div>\
			  <fieldset><legend>Context</legend>\
              <div class="vm_param kvm_opt xen_opt vmware_opt">\
                    <label for="var_name">Name:</label>\
                    <input type="text" id="var_name" name="var_name" />\
                    <div class="tip">Name for the context variable</div>\
              </div>\
              <div class="vm_param kvm_opt xen_opt">\
                    <label for="var_value">Value:</label>\
                    <input type="text" id="var_value" name="var_value" />\
                    <div class="tip">Value of the context variable</div>\
              </div>\
              <div class="">\
                    <button class="add_remove_button add_button" id="add_context_button" value="add_context">Add</button>\
                    <button class="add_remove_button" id="remove_context_button" value="remove_input">Remove selected</button>\
                    <div class="clear"></div>\
                    <label for="context_box">Current variables:</label>\
                    <select id="context_box" name="context_box" style="width:150px;height:100px;" multiple>\
                    </select>\
              </div>\
              </fieldset>\
              </div>\
\
\
			  <!--placement requirements rank -->\
			  <div class="vm_section" id="placement">\
			   <div class="show_hide" id="add_placement_cb">\
			      <h3>Add placement options <a id="add_placement" class="icon_left" href="#"><span class="ui-icon ui-icon-plus" /></a></h3>\
			   </div>\
			  <fieldset><legend>Placement</legend>\
	     	    <div class="vm_param kvm_opt xen_opt vmware_opt">\
				  <label for="REQUIREMENTS">Requirements:</label>\
				  <input type="text" id="REQUIREMENTS" name="requirements" />\
				  <div class="tip">Boolean expression that rules out provisioning hosts from list of machines suitable to run this VM</div>\
			    </div>\
			    <div class="vm_param kvm_opt xen_opt vmware_opt">\
				  <label for="RANK">Rank:</label>\
				  <input type="text" id="RANK" name="rank" />\
				  <div class="tip">	This field sets which attribute will be used to sort the suitable hosts for this VM. Basically, it defines which hosts are more suitable than others</div>\
			    </div>\
			  </fieldset>\
			  </div>\
\
\
			  <!--raw type=> set to current, data -->\
			  <div class="vm_section" id="raw">\
			  	<div class="show_hide" id="add_raw_cb">\
			  	<h3>Add Hypervisor raw options <a id="add_raw" class="icon_left" href="#"><span class="ui-icon ui-icon-plus" /></a></h3>\
			    </div>\
			  <fieldset><legend>Raw</legend>\
			  <!--set TYPE to current xen/kvm -->\
			  	<div class="vm_param kvm_opt xen_opt vmware_opt">\
				  <label for="DATA">Data:</label>\
				  <input type="hidden" id="TYPE" name="type" />\
				  <input type="text" id="DATA" name="data" />\
				  <div class="tip">	Raw data to be passed directly to the hypervisor</div>\
			    </div>\
			  </fieldset>\
			  </div>\
\
\
			  <!-- submit -->\
			 <fieldset>\
			  <div class="form_buttons">\
				<button class="button" id="create_template_form_easy" value="OpenNebula.Template.create">\
				Create\
				</button>\
				<button class="button" id="reset_template_form" type="reset" value="reset">Reset</button>\
			  </div>\
			</fieldset>\
		</form>\
	</div><!--easy mode -->\
	<div id="manual">\
		<form>\
		<h3 style="margin-bottom:10px;">Write the Virtual Machine template here</h3>\
		  <fieldset style="border-top:none;">\
			<textarea id="textarea_vm_template" style="width:100%; height:15em;"></textarea>\
			<div class="clear"></div>\
		  </fieldset>\
		  <fieldset>\
			<div class="form_buttons">\
			  <button class="button" id="create_template_form_manual" value="OpenNebula.Template.create">\
			  Create\
			  </button>\
			<button class="button" type="reset" value="reset">Reset</button>\
			</div>\
		  </fieldset>\
		</form>\
	</div>\
</div>';

var templates_select = "";
var template_list_json = {};
var dataTable_templates;

var template_actions = {
    
    "Template.create" : {
        type: "create",
        call: OpenNebula.Template.create,
        callback: addTemplateElement,
        error: onError,
        notify:true
    },
    
    "Template.create_dialog" : {
        type: "custom",
        call: popUpCreateTemplateDialog
    },
    
    "Template.list" : {
        type: "list",
        call: OpenNebula.Template.list,
        callback: updateTemplatesView,
        error: onError
    },
    
    "Template.show" : {
        type : "single",
        call: OpenNebula.Template.show,
        callback: updateTemplateElement,
        error: onError
    },
    
    "Template.showinfo" : {
        type: "single",
        call: OpenNebula.Template.show,
        callback: updateTemplateInfo,
        error: onError
    },
    
    "Template.refresh" : {
        type: "custom",
        call: function () {
            waitingNodes(dataTable_templates);
            Sunstone.runAction("Template.list");
        },
    },
    
    "Template.autorefresh" : {
        type: "custom",
        call: function() {
            OpenNebula.Template.list({timeout: true, success: updateTemplatesView, error: onError});
        }
    },
    
    "Template.addattr" : {
        type: "multiple",
        call: function(obj){
            var id_attr = obj.data.id;
            var name = $('#template_attr_name').val();
            var value = $('#template_attr_value').val();
            OpenNebula.Template.addattr(
                {data: {
                    id: id_attr,
                    name: name,
                    value: value
                    },
                success: obj.success,
                error: obj.error
            });
        },
        callback : function (req) {
            Sunstone.runAction("Template.show",req.request.data[0]);
        },
        elements: function() { return getSelectedNodes(dataTable_templates); },
        error: onError,
        notify: true
    },
    
    "Template.addattr_dialog" : {
        type: "custom",
        call: popUpTemplateAddattrDialog
    },
    
    "Template.updateattr_dialog" : {
        type: "custom",
        call: popUpTemplateAddattrDialog
    },
    
    "Template.rmattr" : {
        type: "multiple",
        call: function(obj){
            var id_attr = obj.data.id;
            var name = $('#template_attr_name').val();
            OpenNebula.Template.rmattr(
                {data: {
                    id: id_attr,
                    name: name
                    },
                success: obj.success,
                error: obj.error
            });
        },
        callback: function (req) {
            Sunstone.runAction("Template.show",req.request.data[0]);
        },
        elements: function() { return getSelectedNodes(dataTable_templates); },
        error: onError,
        notify: true
    },
    
    "Template.rmattr_dialog" : {
        type: "custom",
        call: popUpTemplateRmattrDialog,
    },
            
    "Template.publish" : {
        type: "multiple",
        call: OpenNebula.Template.publish,
        callback: function (req) {
            Sunstone.runAction("Template.show",req.request.data[0]);
        },
        elements: function() { return getSelectedNodes(dataTable_templates); },
        error: onError,
        notify: true
     },
            
     "Template.unpublish" : {
        type: "multiple",
        call: OpenNebula.Template.unpublish,
        callback: function (req) {
            Sunstone.runAction("Template.show",req.request.data[0]);
        },
        elements: function() { return getSelectedNodes(dataTable_templates); },
        error: onError,
        notify: true
     },
            
     "Template.delete" : {
        type: "multiple",
        call: OpenNebula.Template.delete,
        callback: deleteTemplateElement,
        elements: function() { return getSelectedNodes(dataTable_templates); },
        error: onError,
        notify: true
     }
}


var template_buttons = {
    "Template.refresh" : {
        type: "image",
        text: "Refresh list",
        img: "/images/Refresh-icon.png",
        condition: True
    },
    "Template.create_dialog" : {
        type: "create_dialog",
        text: "+ New",
        condition: True
    },
    "Template.addattr_dialog" : {
        type: "action",
        text: "Add attribute",
        condition: True
    },
    "Template.updateattr_dialog" : {
        type: "action",
        text: "Update attribute",
        condition: True
    },
    "Template.rmattr_dialog" : {
        type: "action",
        text: "Remove attribute",
        condition: True
    },
    "action_list" : {
        type: "select",
        condition: True,
        actions: {
            "Template.publish" : {
                type: "action",
                text: "Publish",
                condition: True                
            },
            "Template.unpublish" : {
                type: "action",
                text: "Unpublish",
                condition: True                
            },
        }
    },
    "Template.delete" : {
        type: "action",
        text: "Delete",
        condition: True
    }
}

var template_info_panel = {
    "template_info_tab" : {
        title: "Template information",
        content: ""
    }    
}

var templates_tab = {
    title: "Templates",
    content: templates_tab_content,
    buttons: template_buttons,
    condition: True
}

Sunstone.addActions(template_actions);
Sunstone.addMainTab('templates_tab',templates_tab);
Sunstone.addInfoPanel('template_info_panel',template_info_panel);

// Returns an array containing the values of the template_json and ready
// to be inserted in the dataTable
function templateElementArray(template_json){
    var template = template_json.VMTEMPLATE;
    return [
        '<input type="checkbox" id="template_'+template.ID+'" name="selected_items" value="'+template.ID+'"/>',
        template.ID,
        template.USERNAME ? template.USERNAME : getUserName(template.UID),
        template.NAME,
        pretty_time(template.REGTIME),
        parseInt(template.PUBLIC) ? "yes" : "no"
        ];
}

// Set up the listener on the table TDs to show the info panel
function templateInfoListener(){

    $('#tbodytemplates tr').live("click",function(e){
        if ($(e.target).is('input')) {return true;}
        popDialogLoading();
        var aData = dataTable_templates.fnGetData(this);
        var id = $(aData[0]).val();
        Sunstone.runAction("Template.showinfo",id);
        return false;
    });
}

//Updates the select input field with an option for each template
function updateTemplateSelect(){
    templates_select = makeSelectOptions(dataTable_templates,1,3,5,"No");
   
    //update static selectors:
    $('#create_vm_dialog #template_id').html(templates_select);
}

// Callback to update an element in the dataTable
function updateTemplateElement(request, template_json){
    var id = template_json.VMTEMPLATE.ID;
    var element = templateElementArray(template_json);
    updateSingleElement(element,dataTable_templates,'#template_'+id);
    updateTemplateSelect();
}

// Callback to remove an element from the dataTable
function deleteTemplateElement(req){
    deleteElement(dataTable_templates,'#template_'+req.request.data);
    updateTemplateSelect();
}

// Callback to add a template element
function addTemplateElement(request, template_json){
    var element = templateElementArray(template_json);
    addElement(element,dataTable_templates);
    //NOTE that the select is not updated because newly added templates
    //are not public
}

// Callback to refresh the list of templates
function updateTemplatesView(request, templates_list){
    template_list_json = templates_list;
    var template_list_array = [];
    $.each(template_list_json,function(){
       template_list_array.push(templateElementArray(this));
    });

    updateView(template_list_array,dataTable_templates);
    updateTemplateSelect();
    updateDashboard("templates",template_list_json);

}

// Prepare the dialog to add/remove/update template attributes
function setupTemplateAttributesDialogs(){
    
    //Append to DOM
    $('div#dialogs').append('<div id="template_attributes_dialog" title="Template attributes"></div>');

    //Put HTML in place
    $('#template_attributes_dialog').html(
        '<form action="javascript:alert(\'js error!\');">\
            <fieldset>\
            <div id="template_attr_action_desc">\
            </div>\
            <div>\
                <label for="template_attr_name">Name:</label>\
                <input type="text" id="template_attr_name" name="template_attr_name" value="" />\
            </div>\
            <div>\
                <label for="template_attr_value">Value:</label>\
               <input type="text" id="template_attr_value" name="template_attr_value" value="" />\
            </div>\
			<div class="form_buttons">\
			  <button class="action_button" id="template_attr_proceed" value="">OK</button>\
			  <button id="template_attr_cancel" value="">Cancel</button>\
			</div>\
            </fieldset>\
        </form>');

    $('#template_attributes_dialog').dialog({
        autoOpen:false,
        width:400,
        modal:true,
        height:220,
        resizable:false,
    });

    $('#template_attributes_dialog button').button();

    //Upcase variable names
    $('#template_attr_name').keyup(function(){
       $(this).val($(this).val().toUpperCase());
    });
    
    $('#template_attributes_dialog #template_attr_proceed').click(function(){
        $('#template_attributes_dialog').dialog('close');
    });
    
    $('#template_attributes_dialog #template_attr_cancel').click(function(){
        $('#template_attributes_dialog').dialog('close');
        return false;
    });

}

// Popup a dialog to add/update an attribute
function popUpTemplateAddattrDialog(){

        //Show value field and label
        $('#template_attr_value').show();
        $('#template_attr_value').prev().show();
        var desc = "Please write the name and value of the attribute. It will be added or updated in all selected templates:";
        $('#template_attr_proceed').val("Template.addattr");
        $('#template_attr_action_desc').html(desc);
        $('#template_attributes_dialog').dialog('open');
        return false;
}

// Popup a dialog to remove an attribute
function popUpTemplateRmattrDialog(){
    
        //Hide value field and label
        $('#template_attr_value').hide();
        $('#template_attr_value').prev().hide();
        var desc = "Please type the attribute you want to remove:";
        $('#template_attr_proceed').val("Template.rmattr");
        $('#template_attr_action_desc').html(desc);
        $('#template_attributes_dialog').dialog('open');
        return false;
}

// Callback to update the information panel tabs and pop it up
function updateTemplateInfo(request,template){
    var template_info = template.VMTEMPLATE;
    var info_tab = {
        title: "Template information",
        content:        
        '<table id="info_template_table" class="info_table">\
			<thead>\
				<tr><th colspan="2">Template "'+template_info.NAME+'" information</th></tr>\
			</thead>\
			<tr>\
				<td class="key_td">ID</td>\
				<td class="value_td">'+template_info.ID+'</td>\
			</tr>\
			<tr>\
				<td class="key_td">Name</td>\
				<td class="value_td">'+template_info.NAME+'</td>\
			</tr>\
			<tr>\
				<td class="key_td">Register time</td>\
				<td class="value_td">'+pretty_time(template_info.REGTIME)+'</td>\
			</tr>\
			<tr>\
				<td class="key_td">Public</td>\
				<td class="value_td">'+(parseInt(template_info.PUBLIC) ? "yes" : "no")+'</td>\
			</tr>\
		</table>\
        <table id="template_template_table" class="info_table">\
		<thead><tr><th colspan="2">Template</th></tr></thead>'+
		prettyPrintJSON(template_info.TEMPLATE)+
		'</table>'
    }
    
    
    Sunstone.updateInfoPanelTab("template_info_panel","template_info_tab",info_tab);
        
    Sunstone.popUpInfoPanel("template_info_panel");

}

// Prepare the template creation dialog
function setupCreateTemplateDialog(){
 //Helper functions for the dialog operations

    // Called when changing tabs. Since we use the same form for both
    // KVM, XEN and others we need to do some operation to update it
    var vmTabChange = function(event,ui){
	// ui.tab     // anchor element of the selected (clicked) tab
	// ui.panel   // element, that contains the selected/clicked tab contents
	// ui.index   // zero-based index of the selected (clicked) tab
        switch(ui.index){
            case 0:
                enable_kvm();
                break;
            case 1:
                enable_xen();
                break;
            case 2:
                enable_vmware();
            case 3:
                break;
        }
        //hide_disabled();
        //show_enabled();
    }
    
    //~ var hide_disabled = function(context) {
        //~ var $disabled;
        //~ if (!context) {
            //~ $disabled = $('.vm_param input:disabled,.vm_param select:disabled');
        //~ } else {
            //~ $disabled = $('.vm_param input:disabled,.vm_param select:disabled',context);
        //~ }
        //~ 
        //~ $disabled.each(function(){
            //~ $(this).parent('.vm_param').hide();
        //~ });
    //~ }
    //~ 
    //~ var show_enabled = function(context){
        //~ var $enabled;
        //~ if (!context) {
            //~ $enabled = $('.vm_param input:enabled,.vm_param select:enabled');
        //~ } else {
            //~ $enabled = $('.vm_param input:enabled,.vm_param select:enabled',context);
        //~ }
        //~ 
        //~ $enabled.parent('.vm_param').show();
    //~ }

    //Using kvm wizard. Updates mandatory tag, optional tags, disable
    //XEN-only (and others) items, enables KVM items
	var enable_kvm = function(){
		man_class="kvm";
		opt_class="kvm_opt";
		$(xen_items).attr("disabled","disabled");
        $(vmware_items).attr("disabled","disabled");
		$(kvm_items).removeAttr("disabled");
        $('.vm_param .man_icon').css("display","none");
        $('.kvm .man_icon').css("display","inline-block");


		//KVM particularities:
        // * Add no_type option for disks
        // * Add driver default option for boot and select it - hide some fields
        // * Set the raw type to kvm
        // * Show the inputs section
        
        var type_opts = 
            '<option id="no_type" value="" selected="selected">None</option>\
            <option value="disk">Disk</option>\
			<option value="floppy">Floppy</option>\
			<option value="cdrom">CD-ROM</option>\
			<option value="swap">Swap</option>\
			<option value="fs">FS</option>\
			<option value="block">Block</option>';
        
		$('div#disks select#TYPE').html(type_opts);


        $('div#kernel_bootloader',section_os_boot).show();
        $('select#boot_method option').removeAttr("selected");
		$('select#boot_method option#no_boot').html("Driver default");
        $('select#boot_method option').removeAttr("selected");
        $('.kernel, .bootloader', $('div#os_boot_opts')).hide();

        var bus_opts = 
                '<option value="ide">IDE</option>\
                <option value="scsi">SCSI</option>\
                <option value="virtio">Virtio</option>';

        $('div#disks select#BUS').html(bus_opts);


		$('input#TYPE', section_raw).val("kvm");

		$(section_inputs).show();
        $(section_graphics).show();
        
        
	};

    // Using XEN wizard. Update mandatory and optional classes, disable
    // KVM-only (and other) items, enable XEN fields...
	var enable_xen = function(){
		man_class="xen";
		opt_class="xen_opt";
		$(kvm_items).attr("disabled","disabled");
        $(vmware_items).attr("disabled","disabled");
		$(xen_items).removeAttr("disabled");
        $('.vm_param .man_icon').css("display","none");
        $('.xen .man_icon').css("display","inline-block");


		// XEN particularities:
        // * Remove no_type option from disks
        // * Remove driver default boot method
        // * Set the raw section to XEN
        // * Hide the inputs section
        
        var type_opts = 
            '<option value="disk">Disk</option>\
			<option value="floppy">Floppy</option>\
			<option value="cdrom">CD-ROM</option>\
			<option value="swap">Swap</option>\
			<option value="fs">FS</option>\
			<option value="block">Block</option>';
            
        $('div#disks select#TYPE').html(type_opts);


        $('div#kernel_bootloader',section_os_boot).show();
		$('select#boot_method option:selected').removeAttr("selected");
        $('select#boot_method option#no_boot').html("Please choose");
		$('.kernel, .bootloader', $('div#os_boot_opts')).hide();

        var bus_opts = 
                '<option value="ide">IDE</option>\
                <option value="scsi">SCSI</option>';

        $('div#disks select#BUS').html(bus_opts);

		$('input#TYPE', section_raw).val("xen");
		$(section_inputs).hide(); //not present for xen
        $(section_graphics).show();
        
        
        
	};

    var enable_vmware = function() {
        man_class="vmware";
		opt_class="vmware_opt";
		$(xen_items).attr("disabled","disabled");
        $(kvm_items).attr("disabled","disabled");
		$(vmware_items).removeAttr("disabled");
        $('.vm_param .man_icon').css("display","none");
        $('.vmware .man_icon').css("display","inline-block");

		//VMWARE particularities
        // * Add no_type option for disks
        // * Set the raw type to kvm
        // * Hide the inputs and graphics section
        // * Hide boot method
        var type_opts = 
            '<option value="file" selected="selected">File</option>\
			<option value="cdrom">CD-ROM</option>\
			<option value="block">Block</option>';
            
        $('div#disks select#TYPE').html(type_opts);

        $('select#boot_method option').removeAttr("selected");
		$('select#boot_method option#no_boot').html("Driver default");
        $('select#boot_method option').removeAttr("selected");
        $('.kernel, .bootloader', $('div#os_boot_opts')).hide();

        var bus_opts = 
                '<option value="ide">IDE</option>\
                <option value="scsi">SCSI</option>';

        $('div#disks select#BUS').html(bus_opts);


		$('input#TYPE', section_raw).val("vmware");

		$(section_inputs).hide();
        $(section_graphics).hide();
        
        $('div#kernel_bootloader',section_os_boot).hide();
        $('.kernel, .bootloader', $('div#os_boot_opts')).hide();
    }

    //This function checks that all mandatory items within a section
    //have some value. Returns true if so, false if not.
	var mandatory_filter = function(context){
			var man_items = "."+man_class;

			//find enabled mandatory items in this context
			man_items = $(man_items+' input:visible, '+man_items+' select:visible',context);
			var r = true;
            
            //we fail it the item is enabled and has no value
			$.each(man_items,function(){
				if ($(this).parents(".vm_param").attr("disabled") ||
					!($(this).val().length)) {
					r = false;
					return false;
				};
			});
			return r;

		};

    //Adds an option element to a multiple select box. Before doing so,
    //it checks that the desired filter is passed
	var box_add_element = function(context,box_tag,filter){
			var value="";
			var params= $('.vm_param',context);
			var inputs= $('input:enabled',params);
			var selects = $('select:enabled',params);
			var fields = $.merge(inputs,selects);

			//are fields passing the filter?
			var result = filter();
			if (!result) {
				notifyError("There are mandatory parameters missing in this section");
				return false;
			}

			value={};
            
            //With each enabled field we form a JSON object
            var id = null;
			$.each(fields,function(){
				if (!($(this).parents(".vm_param").attr("disabled")) &&
					$(this).val().length){
                    //Pick up parent's ID if we do not have one    
					id = $(this).attr('id').length ? $(this).attr('id') :  $(this).parent().attr('id');
					value[id] = $(this).val();
				}
			});
			var value_string = JSON.stringify(value);
			var option= '<option value=\''+value_string+'\'>'+
					stringJSON(value)+
					'</option>';
			$('select'+box_tag,context).append(option);
			return false;
	};

    //Removes selected elements from a multiple select box
	var box_remove_element = function(section_tag,box_tag){
			var context = $(section_tag);
			$('select'+box_tag+' :selected',context).remove();
			return false;
	};

    //Given the JSON of a VM template (or of a section of it), it crawls
    //the fields of certain section (context) and add their name and 
    //values to the template JSON.
	var addSectionJSON = function(template_json,context){
			var params= $('.vm_param',context);
			var inputs= $('input:enabled',params);
			var selects = $('select:enabled',params);
			var fields = $.merge(inputs,selects);

			fields.each(function(){
				if (!($(this).parents(".vm_param").attr("disabled"))){ //if ! disabled
					if ($(this).val().length){ //if has a length
						template_json[$(this).attr('id')]=$(this).val();
					}
				}
			});
	}

    // Given an array (usually empty), a section (context) and a tag for
    // a multiple select in that section, it adds the contents of the 
    // box as objects in the array.
    // TODO: Make it return a new array?
	var addBoxJSON = function(array,context,box_tag){
		$('select'+box_tag+' option',context).each(function(){
				array.push( JSON.parse($(this).val()) );
		});
	}

    //Given an object, removes those elements which are empty
    //Used to clean up a template JSON before submitting 
    //it to opennebula.js
    var removeEmptyObjects = function(obj){
        for (elem in obj){
            var remove = false;
            var value = obj[elem];
            if (value instanceof Array)
            {
                if (value.length == 0)
                    remove = true;
            }
            else if (value instanceof Object)
            {
                var obj_length = 0;
                for (e in value)
                    obj_length += 1;
                if (obj_length == 0)
                    remove = true;
            }
            else
            {
                value = String(value);
                if (value.length == 0)
                    remove = true;
            }
            if (remove)
                delete obj[elem];
        }
        return obj;
    }

    //Toggles the icon when a section is folded/unfolded
	var iconToggle = function(){
		$('.icon_right').toggle(
			function(e){
				$('span',e.currentTarget).removeClass("ui-icon-plusthick");
				$('span',e.currentTarget).addClass("ui-icon-minusthick");
			},function(e){
				$('span',e.currentTarget).removeClass("ui-icon-minusthick");
				$('span',e.currentTarget).addClass("ui-icon-plusthick");
			});
	}

    // Set ups the capacity section
	var capacity_setup = function(){
        //Actually there is nothing to set up, but it used to be
        //possible to hide it like others
        /*
		$('fieldset',section_capacity).hide();
		$('#add_capacity',section_capacity).click(function(){
				$('fieldset',section_capacity).toggle();
				return false;
		});
        */

	}
    
    //Sets up the OS_BOOT section
	var os_boot_setup = function(){
		$('fieldset',section_os_boot).hide();
		$('.bootloader, .kernel',section_os_boot).hide();

		$('#add_os_boot_opts',section_os_boot).click(function(){
			$('fieldset',section_os_boot).toggle();
            return false;
		});


        //Chrome workaround
        $('#boot_method').change(function(){
            $(this).trigger("click");
        });

        //Depending on the boot method we enable/disable some options
        $('#boot_method',section_os_boot).click(function(){
			select = $(this).val();
			switch (select)
			{
				case "kernel":
					$('.bootloader',section_os_boot).hide();
					$('.bootloader',section_os_boot).attr("disabled","disabled");
					$('.kernel',section_os_boot).show();
					$('.kernel',section_os_boot).removeAttr("disabled");
					break;
				case "bootloader":
					$('.kernel',section_os_boot).hide();
					$('.kernel',section_os_boot).attr("disabled","disabled");
					$('.bootloader',section_os_boot).show();
					$('.bootloader',section_os_boot).removeAttr("disabled");
					break;
				default:
					$('.kernel, .bootloader',section_os_boot).hide();
					$('.kernel, .bootloader',section_os_boot).attr("disabled","disabled");
					$('.kernel input, .bootloader input',section_os_boot).val("");
			};
		});
	};

    // Sets up the disk section
	var disks_setup = function(){

		$('fieldset',section_disks).hide();
		$('.vm_param', section_disks).hide();
		//$('#image_vs_disk',section_disks).show();

		$('#add_disks', section_disks).click(function(){
			$('fieldset',section_disks).toggle();
            return false;
		});

        //Depending on adding a disk or a image we need to show/hide
        //different options and make then mandatory or not
		$('#image_vs_disk input',section_disks).click(function(){
			//$('fieldset',section_disks).show();
            $('.vm_param', section_disks).show();
			var select = $('#image_vs_disk :checked',section_disks).val();
			switch (select)
			{
				case "disk":
					$('.add_image',section_disks).hide();
					$('.add_image',section_disks).attr("disabled","disabled");
					$('.add_disk',section_disks).show();
					$('.add_disk',section_disks).removeAttr("disabled");
					$('#TARGET',section_disks).parent().removeClass(opt_class);
					$('#TARGET',section_disks).parent().addClass(man_class);
					break;
				case "image":
					$('.add_disk',section_disks).hide();
					$('.add_disk',section_disks).attr("disabled","disabled");
					$('.add_image',section_disks).show();
					$('.add_image',section_disks).removeAttr("disabled");
					$('#TARGET',section_disks).parent().removeClass(man_class);
					$('#TARGET',section_disks).parent().addClass(opt_class);
					break;
			}
			$('#SIZE',section_disks).parent().hide();
			$('#SIZE',section_disks).parent().attr("disabled","disabled");
			$('#FORMAT',section_disks).parent().hide();
			$('#SIZE',section_disks).parent().attr("disabled","disabled");
			$('#TYPE :selected',section_disks).removeAttr("selected");
            //hide_disabled(section_disks);
		});

        //Chrome workaround
        $('select#TYPE',section_disks).change(function(){
           $(this).trigger('click');
        });

        //Depending on the type of disk we need to show/hide
        //different options and make then mandatory or not
		$('select#TYPE',section_disks).click(function(){
			var select = $(this).val();
			switch (select) {
				//size,format,target
				case "swap":
					//size mandatory
					$('#SIZE',section_disks).parent().show();
					$('#SIZE',section_disks).parent().removeAttr("disabled");
					$('#SIZE',section_disks).parent().removeClass(opt_class);
					$('#SIZE',section_disks).parent().addClass(man_class);

					//target optional
					$('#TARGET',section_disks).parent().removeClass(man_class);
					$('#TARGET',section_disks).parent().addClass(opt_class);

					//format hidden
					$('#FORMAT',section_disks).parent().hide();
					$('#FORMAT',section_disks).parent().attr("disabled","disabled");
					break;
				case "fs":
					//size mandatory
					$('#SIZE',section_disks).parent().show();
					$('#SIZE',section_disks).parent().removeAttr("disabled");
					$('#SIZE',section_disks).parent().removeClass(opt_class);
					$('#SIZE',section_disks).parent().addClass(man_class);

					//target mandatory
					$('#TARGET',section_disks).parent().removeClass(opt_class);
					$('#TARGET',section_disks).parent().addClass(man_class);

					//format mandatory
					$('#FORMAT',section_disks).parent().show();
					$('#FORMAT',section_disks).parent().removeAttr("disabled");
					$('#FORMAT',section_disks).parent().removeClass(opt_class);
					$('#FORMAT',section_disks).parent().addClass(man_class);

					break;
				case "block":
					//size shown and optional
					$('#SIZE',section_disks).parent().show();
					$('#SIZE',section_disks).parent().removeAttr("disabled");
					$('#SIZE',section_disks).parent().removeClass(man_class);
					$('#SIZE',section_disks).parent().addClass(opt_class);

					//target mandatory
					$('#TARGET',section_disks).parent().removeClass(opt_class);
					$('#TARGET',section_disks).parent().addClass(man_class);

					//format hidden
					$('#FORMAT',section_disks).parent().hide();
					$('#FORMAT',section_disks).parent().attr("disabled","disabled");
					break;
				case "floppy":
				case "disk":
				case "cdrom":
                default:
					//size hidden
					$('#SIZE',section_disks).parent().hide();
					$('#SIZE',section_disks).parent().attr("disabled","disabled");

					//target mandatory
					$('#TARGET',section_disks).parent().removeClass(opt_class);
					$('#TARGET',section_disks).parent().addClass(man_class);

					//format optional
				    $('#FORMAT',section_disks).parent().hide();
				    $('#FORMAT',section_disks).parent().attr("disabled","disabled");
			}
            //hide_disabled(section_disks);
		});

        //Our filter for the disks section fields is the mandatory
        //filter for this section
		var diskFilter = function(){
			return mandatory_filter(section_disks);
		};

		$('#add_disk_button',section_disks).click(function(){
			box_add_element(section_disks,'#disks_box',diskFilter);
			return false;
			});
		$('#remove_disk_button',section_disks).click(function(){
			box_remove_element(section_disks,'#disks_box');
			return false;
			});
	};

    // Sets up the network section
	var networks_setup = function(){

		$('.vm_param',section_networks).hide();
		$('fieldset',section_networks).hide();

		$('#add_networks',section_networks).click(function(){
			$('fieldset',section_networks).toggle();
            return false;
		});

        //Depending on adding predefined network or not we show/hide
        //some fields
		$('#network_vs_niccfg input',section_networks).click(function(){

			select = $('#network_vs_niccfg :checked',section_networks).val();
			switch (select) {
				case "network":
					$('.niccfg',section_networks).hide();
					$('.niccfg',section_networks).attr("disabled","disabled");
					$('.network',section_networks).show();
					$('.network',section_networks).removeAttr("disabled");
					break;
				case "niccfg":
					$('.network',section_networks).hide();
					$('.network',section_networks).attr("disabled","disabled");
					$('.niccfg',section_networks).show();
					$('.niccfg',section_networks).removeAttr("disabled");
					break;
			}
            //hide_disabled(section_networks);
		});

    //The filter to add a new network checks that we have selected a 
    //network, or that the ip or mac are set
    //TODO: Improve this check
        var nicFilter = function(){
            return mandatory_filter(section_networks);
        };

		$('#add_nic_button',section_networks).click(function(){
			box_add_element(section_networks,'#nics_box',nicFilter);
			return false;
			});
		$('#remove_nic_button',section_networks).click(function(){
			box_remove_element(section_networks,'#nics_box');
			return false;
			});

	};

    //Sets up the input section - basicly enabling adding and removing from box
	var inputs_setup = function() {
		$('fieldset',section_inputs).hide();

		$('#add_inputs',section_inputs).click(function(){
				$('fieldset',section_inputs).toggle();
                return false;
		});

		$('#add_input_button',section_inputs).click(function(){
			//no filter
			box_add_element(section_inputs,'#inputs_box',True);
			return false;
			});
		$('#remove_input_button',section_inputs).click(function(){
			box_remove_element(section_inputs,'#inputs_box');
			return false;
			});
	};
    
    //Set up the graphics section
	var graphics_setup = function(){
		$('fieldset',section_graphics).hide();
        $('.vm_param',section_graphics).hide();
        $('select#TYPE',section_graphics).parent().show();

		$('#add_graphics',section_graphics).click(function(){
			$('fieldset',section_graphics).toggle();
            return false;
		});

        //Chrome workaround
        $('select#TYPE',section_graphics).change(function(){
            $(this).trigger("click");
        });
		$('select#TYPE',section_graphics).click(function(){
			g_type = $(this).val();
			switch (g_type) {
				case "vnc":
                    $('#LISTEN',section_graphics).parent().show();
					$('#PORT',section_graphics).parent().show();
					$('#PASSWD',section_graphics).parent().show();
					$('#KEYMAP',section_graphics).parent().show();
					$('#PORT',section_graphics).parent().removeAttr("disabled");
					$('#PASSWD',section_graphics).parent().removeAttr("disabled");
					$('#KEYMAP',section_graphics).parent().removeAttr("disabled");
					break;
				case "sdl":
                    $('#LISTEN',section_graphics).parent().show();
					$('#PORT',section_graphics).parent().hide();
					$('#PASSWD',section_graphics).parent().hide();
					$('#KEYMAP',section_graphics).parent().hide();
					$('#PORT',section_graphics).parent().attr("disabled","disabled");
					$('#PASSWD',section_graphics).parent().attr("disabled","disabled");
					$('#KEYMAP',section_graphics).parent().attr("disabled","disabled");
					break;
                default:
                    $('#LISTEN',section_graphics).parent().hide();
					$('#PORT',section_graphics).parent().hide();
					$('#PASSWD',section_graphics).parent().hide();
					$('#KEYMAP',section_graphics).parent().hide();

			}
		});

	}

    //Set up the context section - TODO: Apply improvements here...
	var context_setup = function(){
		$('fieldset',section_context).hide();

		$('#add_context',section_context).click(function(){
                $('fieldset',section_context).toggle();
                return false;
		});
        
        $('#add_context_button', section_context).click(function(){
            var name = $('#var_name',section_context).val();
            var value = $('#var_value',section_context).val();
            if (!name.length || !value.length) {
                notifyError("Context variable name and value must be filled in");
                return false;
            }
            option= '<option value=\''+value+'\' name=\''+name+'\'>'+
            name+'='+value+
            '</option>';
            $('select#context_box',section_context).append(option);
            return false; 
        });
        
        $('#remove_context_button', section_context).click(function(){
           box_remove_element(section_context,'#context_box');
           return false; 
        });


	};

    // Set up the placement section
	var placement_setup = function(){
		$('fieldset',section_placement).hide();

		$('#add_placement',section_placement).click(function(){
				$('fieldset',section_placement).toggle();
                return false;
		});

	};

    // Set up the raw section
	var raw_setup = function(){
		$('fieldset',section_raw).hide();

		$('#add_raw',section_raw).click(function(){
				$('fieldset',section_raw).toggle();
                return false;
		});
	};
    
    //***CREATE VM DIALOG MAIN BODY***
    
    $('div#dialogs').append('<div title="Create VM Template" id="create_template_dialog"></div>');
	//Insert HTML in place
	$('#create_template_dialog').html(create_template_tmpl);
    //Enable tabs
	$('#template_create_tabs').tabs({
        select:vmTabChange
        });

	//Prepare jquery dialog
    var height = Math.floor($(window).height()*0.8); //set height to a percentage of the window
	$('#create_template_dialog').dialog({
		autoOpen: false,
		modal: true,
		width: 700,
        height: height
	});
    
    // Enhace buttons
    $('#create_template_dialog button').button();
    // Setup tips200
    setupTips($('#create_template_dialog'));
    
    //Enable different icon for folded/unfolded categories
    iconToggle(); //toogle +/- buttons

	//Sections, used to stay within their scope
	var section_capacity = $('#capacity');
	var section_os_boot = $('#os_boot_opts');
	var section_disks = $('#disks');
	var section_networks = $('#networks');
	var section_inputs = $('#inputs');
	var section_graphics = $('#graphics');
	var section_context = $('#context');
	var section_placement = $('#placement');
	var section_raw = $('#raw');

	//Different selector for items of kvm and xen (mandatory and optional)
	var items = '.vm_param input,.vm_param select';
	var kvm_man_items = '.kvm input,.kvm select';
	var kvm_opt_items = '.kvm_opt input, .kvm_opt select';
	var kvm_items = kvm_man_items +','+kvm_opt_items;
	var xen_man_items = '.xen input,.xen select';
	var xen_opt_items = '.xen_opt input, .xen_opt select';
	var xen_items = xen_man_items +','+ xen_opt_items;
    var vmware_man_items = '.vmware input,.vmware select';
	var vmware_opt_items = '.vmware_opt input, .vmware_opt select';
	var vmware_items = vmware_man_items +','+ vmware_opt_items;

	//Starting template type, optional items class and mandatory items class
	var templ_type = "kvm";
	var opt_class=".kvm_opt";
	var man_class=".kvm";

	enable_kvm(); //enable all kvm options

    //Fold/unfold all sections button
    $('#fold_unfold_vm_params').toggle(
        function(){
            $('.vm_section fieldset').show();
            return false;
        },
        function(){
            $('.vm_section fieldset').hide();
            $('.vm_section fieldset').first().show(); //Show capacity opts
            return false;
        });

    //initialise all sections
	capacity_setup();
	os_boot_setup();
	disks_setup();
	networks_setup();
	inputs_setup();
	graphics_setup();
	context_setup();
	placement_setup();
	raw_setup();

    //Process form
	$('button#create_template_form_easy').click(function(){
		//validate form

		var vm_json = {};

		//process capacity options
		var scope = section_capacity;

		if (!mandatory_filter(scope)){
			notifyError("There are mandatory fields missing in the capacity section");
			return false;
		};
		addSectionJSON(vm_json,scope);

		//process os_boot_opts
		scope= section_os_boot;
		switch (templ_type){
			case "xen":
                boot_method = $('#boot_method option:selected',scope).val();
				if (!boot_method.length){
					notifyError("Xen templates must specify a boot method");
					return false;}
		};

		if (!mandatory_filter(scope)){
			notifyError("There are mandatory fields missing in the OS Boot options section");
			return false;
		};
        vm_json["OS"] = {};
		addSectionJSON(vm_json["OS"],scope);

		//process disks -> fetch from box
		scope = section_disks;
		vm_json["DISK"] = [];
		addBoxJSON(vm_json["DISK"],scope,'#disks_box');

		//process nics -> fetch from box
		scope = section_networks;
		vm_json["NIC"] = [];
		addBoxJSON(vm_json["NIC"],scope,'#nics_box');

		//process inputs -> fetch from box
		scope = section_inputs;
		vm_json["INPUT"] = [];
		addBoxJSON(vm_json["INPUT"],scope,'#inputs_box');

		//process graphics -> fetch fields with value
		scope = section_graphics;
		vm_json["GRAPHICS"] = {};
		addSectionJSON(vm_json["GRAPHICS"],scope);

        //context
        scope = section_context;
        var context = $('#CONTEXT',scope).val();
        vm_json["CONTEXT"] = {};
        $('#context_box option',scope).each(function(){
            name = $(this).attr("name");
            value = $(this).val();
            vm_json["CONTEXT"][name]=value;
        });

		//placement -> fetch with value
		scope = section_placement;
		addSectionJSON(vm_json,scope);

		//raw -> if value set type to driver and fetch
		scope = section_raw;
		vm_json["RAW"] = {};
		addSectionJSON(vm_json["RAW"],scope);

        // remove empty elements
        vm_json = removeEmptyObjects(vm_json);

        //wrap it in the "vmtemplate" object
        vm_json = {vmtemplate: vm_json};
        
        
        Sunstone.runAction("Template.create",vm_json);
		
        $('#create_template_dialog').dialog('close');
		return false;
	});

    //Handle manual forms
	$('button#create_template_form_manual').click(function(){
		var template = $('#textarea_vm_template').val();

        //wrap it in the "vm" object
        template = {"vmtemplate": {"template_raw": template}};

        Sunstone.runAction("Template.create",template);
		 $('#create_template_dialog').dialog('close');
		return false;
	});

    //Reset form - empty boxes
	$('button#reset_vm_form').click(function(){
		$('select#disks_box option',section_disks).remove();
		$('select#nics_box option',section_networks).remove();
		$('select#inputs_box option',section_inputs).remove();
		return true;
	});



}

function popUpCreateTemplateDialog(){
    $('#create_template_dialog').dialog('open');
}

// Set the autorefresh interval for the datatable
function setTemplateAutorefresh() {
     setInterval(function(){
		var checked = $('input:checked',dataTable_templates.fnGetNodes());
        var filter = $("#datatable_templates_filter input").attr("value");
		if (!checked.length && !filter.length){
            Sunstone.runAction("Template.autorefresh");
		}
	},INTERVAL+someTime());
}

//The DOM is ready at this point
$(document).ready(function(){
    
   dataTable_templates = $("#datatable_templates").dataTable({
        "bJQueryUI": true,
        "bSortClasses": false,
        "bAutoWidth":false,
        "sPaginationType": "full_numbers",
        "aoColumnDefs": [
                        { "bSortable": false, "aTargets": ["check"] },
                        { "sWidth": "60px", "aTargets": [0,3] },
                        { "sWidth": "35px", "aTargets": [1] },
                        { "sWidth": "100px", "aTargets": [2,3] }
                       ]
    });
    
    dataTable_templates.fnClearTable();
    addElement([
        spinner,
        '','','','',''],dataTable_templates);
    Sunstone.runAction("Template.list");
    
    setupCreateTemplateDialog();
    setupTemplateAttributesDialogs();
    setTemplateAutorefresh();
    
    initCheckAllBoxes(dataTable_templates);
    tableCheckboxesListener(dataTable_templates);
    templateInfoListener();
    
})
