{#
name: On-Prem SSH Cluster
description: |
  <p>Creates a cluster on your on-prem (local) infrastructure.</p>
  <ul>
    <li><strong>Requirements</strong>: Hosts must have the OS installed and be reachable via SSH.</li>
    <li><strong>Storage</strong>: VM images are copied to each host over SSH and stored on local disk.</li>
    <li><strong>Network</strong>: VMs use a flat bridged network via a physical NIC on every host.</li>
  </ul>

user_inputs:
  - name: phydev_name
    description: Host NIC used to bridge the VM network (must exist on all hosts), e.g. eth0 or ens3
    type: string
    default: "eth0"

  - name: network_address
    description: Network base address for the bridged VM network, e.g. 10.0.0.0
    type: string
    default: "10.0.0.0"

  - name: network_mask
    description: Network mask for the bridged VM network, e.g. 255.255.255.0
    type: string
    default: "255.255.255.0"

  - name: gateway
    description: Default gateway IP for VMs in this network
    type: string
    default: "10.0.0.1"

  - name: dns
    description: DNS server IP used by VMs
    type: string
    default: "8.8.8.8"

  - name: ip
    description: First IP address to allocate for VMs from this network
    type: string
    default: "10.0.0.50"

  - name: size
    description: Number of consecutive IPs to allocate starting from the first IP
    type: number
    default: 100
#}

---
all:
  vars:
    ansible_user: ubuntu
    one_version: "{{ one.version }}"

    vn:
      private_onprem_network:
        managed: true
        template:
          vn_mad: bridge
          phydev: "{{ user_inputs.phydev_name }}"
          network_address: "{{ user_inputs.network_address }}"
          network_mask: "{{ user_inputs.network_mask }}"
          gateway: "{{ user_inputs.gateway }}"
          dns: "{{ user_inputs.dns }}"
          ar:
            - type: IP4
              ip: "{{ user_inputs.ip }}"
              size: "{{ user_inputs.size }}"

    ds:
      mode: generic
      config:
        SYSTEM_DS:
          onprem_system_ds:
            id: "{{ one.system_ds_id }}"
            template:
              type: SYSTEM_DS
              tm_mad: ssh
        IMAGE_DS:
          onprem_image_ds:
            id: "{{ one.image_ds_id }}"
            template:
              type: IMAGE_DS
              ds_mad: fs
              tm_mad: ssh
              safe_dirs: /var/tmp /tmp

frontend:
  hosts:
    f1: { ansible_user: root, ansible_host: "{{ one.frontend_ip }}" }

node:
  hosts:
    {% for node in one.nodes %}
    n{{ loop.index }}: { ansible_user: root, ansible_host: "{{ node }}" }
    {% endfor %}
